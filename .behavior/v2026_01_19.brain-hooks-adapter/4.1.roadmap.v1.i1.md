# roadmap: brain hooks adapter for claude code

## overview

checklist-style roadmap to implement brain hooks adapter per blueprint.

**dependencies flow**:
```
[0] deps
  ↓
[1] config.dao
  ↓
[2] translateHook ←──────────┐
  ↓                          │
[3] genBrainHooksAdapter ────┘
  ↓
[4] getBrainHooks
  ↓
[5] sdk exports
  ↓
[6] final verification
```

---

## phase 0: dependencies

### 0.1 install iso-time

- [ ] add `iso-time` to dependencies in package.json
- [ ] run npm install

**acceptance criteria**:
- `import { toMilliseconds } from 'iso-time'` resolves without error

**verification**:
```bash
npm run build:compile
```

---

## phase 1: config.dao

**depends on**: phase 0

### 1.1 implement config.dao.ts

- [ ] create `src/domain.operations/hooks/config.dao.ts`
- [ ] export `ClaudeCodeHookEntry` interface
- [ ] export `ClaudeCodeSettings` interface
- [ ] implement `readClaudeCodeSettings({ from })`
- [ ] implement `writeClaudeCodeSettings({ settings, to })`

**acceptance criteria**:
- types compile without error
- functions are exported

**verification**:
```bash
npm run build:compile
```

### 1.2 implement config.dao.integration.test.ts

- [ ] create `src/domain.operations/hooks/config.dao.integration.test.ts`
- [ ] [case1] empty repo - read returns `{}`
- [ ] [case1] empty repo - write creates .claude/settings.json
- [ ] [case2] .claude dir only - read returns `{}`
- [ ] [case3] prior settings (no hooks) - preserves non-hook settings
- [ ] [case4] prior settings (with hooks) - reads hooks correctly
- [ ] [case5] json format - 2-space indent, newline at end
- [ ] [case6] multiple hook events - SessionStart + PreToolUse + Stop
- [ ] [case7] author attribute - persisted and read back
- [ ] [case8] empty hooks section - `{}` preserved

**acceptance criteria**:
- all 8 cases pass
- file persistence verified against tmpdir

**verification**:
```bash
npm run test:integration -- config.dao.integration.test.ts
```

---

## phase 2: translateHook

**depends on**: phase 1 (uses ClaudeCodeHookEntry type)

### 2.1 implement translateHook.ts

- [ ] create `src/domain.operations/hooks/translateHook.ts`
- [ ] define `EVENT_MAP` constant
- [ ] implement `translateHookToClaudeCode({ hook })`
- [ ] implement `translateHookFromClaudeCode({ event, entry })`

**acceptance criteria**:
- functions compile with correct input/output types
- imports `BrainHook`, `BrainHookEvent` from rhachet

**verification**:
```bash
npm run build:compile
```

### 2.2 implement translateHook.test.ts

- [ ] create `src/domain.operations/hooks/translateHook.test.ts`
- [ ] [case1] translateHookToClaudeCode: onBoot → SessionStart
- [ ] [case2] translateHookToClaudeCode: onTool → PreToolUse
- [ ] [case3] translateHookToClaudeCode: onStop → Stop
- [ ] [case4] translateHookToClaudeCode: timeout IsoDuration → milliseconds
- [ ] [case5] translateHookToClaudeCode: filter.what → matcher
- [ ] [case6] translateHookToClaudeCode: no filter → matcher `*`
- [ ] [case7] translateHookToClaudeCode: author → entry.author
- [ ] [case8] translateHookFromClaudeCode: SessionStart → onBoot
- [ ] [case9] translateHookFromClaudeCode: PreToolUse → onTool
- [ ] [case10] translateHookFromClaudeCode: Stop → onStop
- [ ] [case11] translateHookFromClaudeCode: timeout ms → IsoDuration
- [ ] [case12] translateHookFromClaudeCode: no timeout → { seconds: 30 }
- [ ] [case13] translateHookFromClaudeCode: matcher → filter.what
- [ ] [case14] translateHookFromClaudeCode: matcher `*` → no filter
- [ ] [case15] translateHookFromClaudeCode: entry.author → hook.author
- [ ] [case16] translateHookFromClaudeCode: no author → 'unknown'
- [ ] [case17] translateHookFromClaudeCode: unknown event → empty array
- [ ] [case18] translateHookFromClaudeCode: multiple hooks → multiple BrainHook

**acceptance criteria**:
- all translation cases pass
- bidirectional round-trip preserves data

**verification**:
```bash
npm run test:unit -- translateHook.test.ts
```

---

## phase 3: genBrainHooksAdapterForClaudeCode

**depends on**: phase 1 + phase 2

### 3.1 implement genBrainHooksAdapterForClaudeCode.ts

- [ ] create `src/domain.operations/hooks/genBrainHooksAdapterForClaudeCode.ts`
- [ ] implement factory function
- [ ] implement `dao.get.one({ by: { unique } })`
- [ ] implement `dao.get.all(filter?)`
- [ ] implement `dao.set.findsert({ hook })`
- [ ] implement `dao.set.upsert({ hook })`
- [ ] implement `dao.del({ by: { unique } })`
- [ ] return adapter with `slug: 'claude-code'`

**acceptance criteria**:
- factory returns `BrainHooksAdapter` shape
- all dao methods are defined

**verification**:
```bash
npm run build:compile
```

### 3.2 implement genBrainHooksAdapterForClaudeCode.test.ts (unit)

- [ ] create `src/domain.operations/hooks/genBrainHooksAdapterForClaudeCode.test.ts`
- [ ] adapter.slug equals 'claude-code'
- [ ] adapter.dao.get is defined
- [ ] adapter.dao.set is defined
- [ ] adapter.dao.del is defined

**acceptance criteria**:
- unit tests pass
- adapter shape verified

**verification**:
```bash
npm run test:unit -- genBrainHooksAdapterForClaudeCode.test.ts
```

### 3.3 implement genBrainHooksAdapterForClaudeCode.integration.test.ts

- [ ] create `src/domain.operations/hooks/genBrainHooksAdapterForClaudeCode.integration.test.ts`
- [ ] [case1] empty repo - dao.get.all returns `[]`
- [ ] [case1] empty repo - dao.set.upsert creates settings.json
- [ ] [case2] repo with hooks - dao.get.all returns all
- [ ] [case2] repo with hooks - dao.get.all filter by author
- [ ] [case2] repo with hooks - dao.get.all filter by event
- [ ] [case2] repo with hooks - dao.get.all filter by command
- [ ] [case3] dao.get.one - hook present returns hook
- [ ] [case3] dao.get.one - hook absent returns null
- [ ] [case4] dao.set.upsert - creates new hook
- [ ] [case4] dao.set.upsert - updates timeout/filter on found
- [ ] [case4] dao.set.upsert - no duplicate created
- [ ] [case5] dao.set.findsert - creates new hook
- [ ] [case5] dao.set.findsert - idempotent (twice = one entry)
- [ ] [case6] dao.del - removes hook
- [ ] [case6] dao.del - get.one returns null after
- [ ] [case6] dao.del - absent hook no error
- [ ] [case7] hook with filter - persisted and read
- [ ] [case8] multiple authors - isolation verified

**acceptance criteria**:
- all 8 integration cases pass
- dao contract verified end-to-end

**verification**:
```bash
npm run test:integration -- genBrainHooksAdapterForClaudeCode.integration.test.ts
```

---

## phase 4: getBrainHooks

**depends on**: phase 3

### 4.1 implement getBrainHooks.ts

- [ ] create `src/domain.operations/hooks/getBrainHooks.ts`
- [ ] implement `getBrainHooks({ brain, repoPath })`
- [ ] support `'claude'` alias
- [ ] support `'claude-code'` alias
- [ ] support `'anthropic/claude/code'` alias
- [ ] return `null` for unsupported brains

**acceptance criteria**:
- function compiles with correct types
- returns `BrainHooksAdapter | null`

**verification**:
```bash
npm run build:compile
```

### 4.2 implement getBrainHooks.test.ts

- [ ] create `src/domain.operations/hooks/getBrainHooks.test.ts`
- [ ] [case1] brain 'claude' → adapter with slug 'claude-code'
- [ ] [case2] brain 'claude-code' → adapter with slug 'claude-code'
- [ ] [case3] brain 'anthropic/claude/code' → adapter
- [ ] [case4] brain 'opencode' → null
- [ ] [case5] brain unknown string → null

**acceptance criteria**:
- all specifier cases pass
- correct adapter returned or null

**verification**:
```bash
npm run test:unit -- getBrainHooks.test.ts
```

---

## phase 5: sdk exports

**depends on**: phase 4

### 5.1 update contract/sdk/index.ts

- [ ] add export for `getBrainHooks`
- [ ] add export for `genBrainHooksAdapterForClaudeCode`

**acceptance criteria**:
- exports visible from package entrypoint

**verification**:
```bash
npm run build:compile
```

### 5.2 verify sdk exports work

- [ ] update `src/contract/sdk/index.test.ts` with brain hooks tests
- [ ] verify `getBrainHooks` is exported
- [ ] verify `genBrainHooksAdapterForClaudeCode` is exported

**acceptance criteria**:
- sdk test passes
- consumers can import from package

**verification**:
```bash
npm run test:unit -- src/contract/sdk/index.test.ts
```

---

## phase 6: final verification

**depends on**: all phases

### 6.1 run full test suite

- [ ] all unit tests pass
- [ ] all integration tests pass
- [ ] no type errors

**verification**:
```bash
npm run test:types
npm run test:lint
npm run test:unit
npm run test:integration
```

### 6.2 build verification

- [ ] build completes without error
- [ ] dist/ contains compiled output

**verification**:
```bash
npm run build
```

### 6.3 acceptance criteria checklist

- [ ] `getBrainHooks` returns adapter for `'claude'`
- [ ] `getBrainHooks` returns adapter for `'claude-code'`
- [ ] `getBrainHooks` returns adapter for `'anthropic/claude/code'`
- [ ] adapter fulfills `BrainHooksAdapterDao` contract
- [ ] hooks persist to `.claude/settings.json`
- [ ] author namespace isolation via `entry.author` attribute
- [ ] bidirectional translation preserves data
- [ ] idempotent operations (findsert, upsert)
- [ ] types import from `rhachet` package

---

## summary

| phase | files | tests |
|-------|-------|-------|
| 0 | package.json | - |
| 1 | config.dao.ts | config.dao.integration.test.ts |
| 2 | translateHook.ts | translateHook.test.ts |
| 3 | genBrainHooksAdapterForClaudeCode.ts | unit + integration |
| 4 | getBrainHooks.ts | getBrainHooks.test.ts |
| 5 | contract/sdk/index.ts | index.test.ts |
| 6 | - | full suite |

**total new files**: 9
**total test cases**: ~40+
